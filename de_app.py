# -*- coding: utf-8 -*-
"""de_app.ipynb

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1z7E797FJT2Gfhhr9gYCxoOt5rM4wEO0B
"""

import streamlit as st
from transformers import pipeline

# ----------------------------------------------------
# 1. GA4 íƒœê·¸ ì‚½ì… í•¨ìˆ˜ ì •ì˜ (ê°€ì¥ ë¨¼ì € ì‹¤í–‰ë˜ì–´ì•¼ í•¨)
# ----------------------------------------------------
def inject_ga4_tag(tracking_id):
    """GA4 ì¸¡ì • IDë¥¼ ì‚¬ìš©í•˜ì—¬ HTML íƒœê·¸ë¥¼ Streamlit ì•±ì— ì‚½ì…í•©ë‹ˆë‹¤."""

    # í…œí”Œë¦¿ ë¦¬í„°ëŸ´ì„ ì‚¬ìš©í•˜ì—¬ tracking_idë¥¼ ë™ì ìœ¼ë¡œ ì‚½ì…
    ga4_script = f"""
        <!-- Google tag (gtag.js) -->
        <script async src="https://www.googletagmanager.com/gtag/js?id={tracking_id}"></script>
        <script>
          window.dataLayer = window.dataLayer || [];
          function gtag(){{dataLayer.push(arguments);}}
          gtag('js', new Date());
          gtag('config', '{tracking_id}', {{
              'cookie_flags': 'secure;samesite=none'
          }});
        </script>
    """
    # Streamlit ì•±ì˜ ìµœìƒë‹¨ì— HTMLì„ ì‚½ì…í•©ë‹ˆë‹¤.
    # ì•ˆì „ì„± ë° ì´ˆê¸°í™”ë¥¼ ìœ„í•´ ì•± ì‹¤í–‰ì˜ ë§¨ ì²˜ìŒì— ìœ„ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
    st.markdown(ga4_script, unsafe_allow_html=True)


# ----------------------------------------------------
# 2. GA4 ì´ë²¤íŠ¸ ì „ì†¡ í•¨ìˆ˜ ì •ì˜
# ----------------------------------------------------
def send_ga4_event(event_name, event_params={}):
    """
    GA4 ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•˜ëŠ” JavaScript ì½”ë“œë¥¼ Streamlit ì•±ì— ì‚½ì…í•©ë‹ˆë‹¤.
    ì´ í•¨ìˆ˜ëŠ” ì‚¬ìš©ì ìƒí˜¸ ì‘ìš©(ì˜ˆ: ë²„íŠ¼ í´ë¦­)ì´ ìˆì„ ë•Œ í˜¸ì¶œë˜ì–´ì•¼ í•©ë‹ˆë‹¤.
    """
    # ì´ë²¤íŠ¸ ë§¤ê°œë³€ìˆ˜ë¥¼ JSON ë¬¸ìì—´ë¡œ ë³€í™˜
    params_json = str(event_params).replace("'", '"')

    # gtag('event', ...) í˜¸ì¶œì„ ìˆ˜í–‰í•˜ëŠ” JavaScript
    js_code = f"""
        <script>
            if (typeof gtag === 'function') {{
                gtag('event', '{event_name}', {params_json});
            }}
        </script>
    """
    # ì´ë²¤íŠ¸ë¥¼ ì „ì†¡í•˜ëŠ” JavaScriptë¥¼ í˜ì´ì§€ì— ì‚½ì…
    # keyë¥¼ ì‚¬ìš©í•˜ì—¬ ë§¤ë²ˆ ì¬ì‹¤í–‰ë˜ë„ë¡ í•©ë‹ˆë‹¤.
    st.components.v1.html(js_code, height=0, width=0)

# GA4 íƒœê·¸ ì‚½ì… (ì•±ì˜ ë§¨ ì²˜ìŒì— ì‹¤í–‰)
# G-BPJTDJ4BKF ëŒ€ì‹  ì‹¤ì œ ì¸¡ì • IDë¥¼ ì‚¬ìš©í•˜ì„¸ìš”.
inject_ga4_tag("G-BPJTDJ4BKF")


# ì €ì¥ëœ ëª¨ë¸ ê²½ë¡œ (Hugging Face Model Hub ì‚¬ìš©)
MODEL_PATH = "ju03/Chatbot_Emotion-classification"

# ëª¨ë¸ ë¡œë“œ (ì•±ì´ ë¡œë“œë  ë•Œ í•œ ë²ˆë§Œ ì‹¤í–‰)
@st.cache_resource
def load_model():
    # í…ìŠ¤íŠ¸ ë¶„ë¥˜ íŒŒì´í”„ë¼ì¸ ì‚¬ìš©
    try:
        classifier = pipeline(
            "text-classification",
            model=MODEL_PATH,
            tokenizer=MODEL_PATH
        )
        return classifier
    except Exception as e:
        st.error(f"ëª¨ë¸ ë¡œë“œ ì‹¤íŒ¨! ë‹¤ìŒ ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ 'requirements.txt'ì— ìˆëŠ”ì§€ í™•ì¸í•˜ì„¸ìš”: streamlit, transformers, torch (ë˜ëŠ” tensorflow)")
        return None

classifier = load_model()

st.title('ë°°ë‹¬ ì•± ë¦¬ë·° ê°ì„± ë¶„ë¥˜ ë´‡ ğŸ¤–')
st.write('íŒŒì¸íŠœë‹ëœ KLUE/RoBERTa ëª¨ë¸ë¡œ ë¦¬ë·°ë¥¼ ê¸ì •/ë¶€ì • ë¶„ë¥˜í•©ë‹ˆë‹¤.')

# í…ìŠ¤íŠ¸ ì˜ì—­ ìƒì„±
review_text = st.text_area("ë¦¬ë·°ë¥¼ ì—¬ê¸°ì— ì…ë ¥í•˜ì„¸ìš”:", height=150, placeholder="ì˜ˆ: 'ë°°ë‹¬ì´ ë„ˆë¬´ ë¹¨ëê³  ìŒì‹ì´ ì •ë§ ë§›ìˆì—ˆì–´ìš”!'")

with st.expander("ì˜ˆì‹œ ë¦¬ë·° ë³´ê¸°"):
    st.write("ğŸ‘ ê¸ì • ì˜ˆì‹œ: ì‚¬ì¥ë‹˜ì´ ë„ˆë¬´ ì¹œì ˆí•˜ì‹œê³  ì„œë¹„ìŠ¤ë„ ì¢‹ì•„ì„œ ë‹¤ìŒì—ë„ ê¼­ ì£¼ë¬¸í•˜ê³  ì‹¶ì–´ìš”!")
    st.write("ğŸ‘ ë¶€ì • ì˜ˆì‹œ: ì£¼ë¬¸í•œ ë©”ë‰´ê°€ ì˜ëª» ì™”ê³ , í¬ì¥ì´ ì—‰ë§ì´ë¼ ë‹¤ ì‹ì–´ì„œ ì™”ë„¤ìš”.")


if st.button('ë¶„ë¥˜í•˜ê¸°'):
    if not classifier:
        st.warning("ëª¨ë¸ì´ ë¡œë“œë˜ì§€ ì•Šì•„ ë¶„ë¥˜ë¥¼ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.")
    elif review_text.strip() == "":
        st.warning("ë¶„ë¥˜í•  ë¦¬ë·° í…ìŠ¤íŠ¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.")
    else:
        # ì§„í–‰ë¥  í‘œì‹œì¤„
        with st.spinner('ë¦¬ë·° ë¶„ì„ ì¤‘...'):

            # ì˜ˆì¸¡ ìˆ˜í–‰
            result = classifier(review_text)[0]

        label = result['label']
        score = result['score']

        # ê²°ê³¼ ë§¤í•‘
        sentiment = 'ê¸ì • ğŸ‘' if label == 'LABEL_1' else 'ë¶€ì • ğŸ‘'

        # ----------------------------------------------------
        # 3. GA4 ì´ë²¤íŠ¸ ì „ì†¡ (ë¶„ë¥˜ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸)
        # ----------------------------------------------------
        send_ga4_event(
            event_name="review_classified",
            event_params={
                "sentiment_label": sentiment,
                "confidence_score": f"{score:.2f}",
                "review_length": len(review_text)
            }
        )
        # ----------------------------------------------------

        st.success('âœ… ë¶„ë¥˜ ì™„ë£Œ!')
        st.metric(label="ë¶„ë¥˜ ê²°ê³¼", value=sentiment)
        st.info(f"ì‹ ë¢°ë„: {score*100:.2f}%")